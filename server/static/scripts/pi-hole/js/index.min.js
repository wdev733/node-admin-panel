/*! pi1 - v1.0.0
Generated:  2017 - 01 - 27  */
function objectToArray(a){var b=Object.keys(a);b.sort(function(a,b){return a-b});for(var c=[],d=[],e=0;e<b.length;e++)c.push(a[b[e]]),d.push(b[e]);return[d,c]}function escapeHtml(a){var b={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return a.replace(/[&<>"']/g,function(a){return b[a]})}const padNumber=function(a){return("00"+a).substr(-2,2)};var summaryUpdater={};!function(a){var b={adsBlockedToday:-1,dnsQueriesToday:-1,domainsBeingBlocked:-1,adsPercentageToday:-1},c={};c.socketUpdate=function(c){c.type&&("block"===c.type&&b.adsBlockedToday++,b.dnsQueriesToday++,b.adsPercentageToday=b.adsBlockedToday/b.dnsQueriesToday*100,a.updateView())},a.updateView=function(){["adsBlockedToday","dnsQueriesToday","domainsBeingBlocked","adsPercentageToday"].forEach(function(a,c){var d=3===c?b[a].toFixed(2)+"%":b[a];$("h3#"+a).text(d)}),$("#toprow-stats .overlay").each(function(a,b){$(b).is(":visible")&&$(b).hide()})},a.pollData=function(){$.getJSON("/api/data?summary",function(a){b=a.summary}).done(function(){a.updateView()}).fail(function(){setTimeout(a.pollData,300)})},a.subscribeSocket=function(){taillogWatcher.on("dns",c.socketUpdate)},a.unsubscribeSocket=function(){taillogWatcher.off("dns",c.socketUpdate)},a.start=function(){a.pollData(),a.subscribeSocket()}}(summaryUpdater);var queryTimelineUpdater={};!function(a){var b,c,d=0,e={};const f={labels:[],datasets:[{label:"Total DNS Queries",fill:!0,backgroundColor:"rgba(220,220,220,0.5)",borderColor:"rgba(0, 166, 90,.8)",pointBorderColor:"rgba(0, 166, 90,.8)",pointRadius:1,pointHoverRadius:5,data:[],pointHitRadius:5,cubicInterpolationMode:"monotone"},{label:"Blocked DNS Queries",fill:!0,backgroundColor:"rgba(0,192,239,0.5)",borderColor:"rgba(0,192,239,1)",pointBorderColor:"rgba(0,192,239,1)",pointRadius:1,pointHoverRadius:5,data:[],pointHitRadius:5,cubicInterpolationMode:"monotone"}]},g={tooltips:{enabled:!0,mode:"x-axis",callbacks:{title:function(a,b){var c=a[0].xLabel,d=c.match(/(\d?\d):?(\d?\d?)/),e=parseInt(d[1],10),f=parseInt(d[2],10)||0,g=padNumber(e)+":"+padNumber(f)+":00",h=padNumber(e)+":"+padNumber(f+9)+":59";return"Queries from "+g+" to "+h},label:function(a,b){if(1===a.datasetIndex){var c=0,d=parseInt(b.datasets[0].data[a.index]),e=parseInt(b.datasets[1].data[a.index]);return d>0&&(c=100*e/d),b.datasets[a.datasetIndex].label+": "+a.yLabel+" ("+c.toFixed(1)+"%)"}return b.datasets[a.datasetIndex].label+": "+a.yLabel}}},legend:{display:!1},scales:{xAxes:[{type:"time",time:{unit:"hour",displayFormats:{hour:"HH:mm"},tooltipFormat:"HH:mm"}}],yAxes:[{ticks:{beginAtZero:!0}}]},maintainAspectRatio:!1},h={type:"line",data:f,options:g},i=function(a,b){return a-b};a.pollData=function(){$.getJSON("/api/data?overTimeData",function(b){c=b.overTimeData,a.updateTable()}).done(function(){d=0,setTimeout(a.pollData,6e5)}).fail(function(){d++,d<5&&setTimeout(a.pollData,6e4)})},a.updateTable=function(){b.data.labels=[],b.data.datasets[0].data=[],b.data.datasets[1].data=[];for(var a=Object.keys(c.ads).map(Number).sort(i),d=Object.keys(c.domains).map(Number).sort(i),e=Math.max(a[a.length-1],d[d.length-1]),f=Math.min(a[0],d[0]),g=f;g<=e;g++){var h=g,j=(new Date).setHours(Math.floor(h/6),10*(h%6),0,0);b.data.labels.push(j),b.data.datasets[0].data.push(g in c.domains?c.domains[g]:0),b.data.datasets[1].data.push(g in c.ads?c.ads[g]:0)}$("#queries-over-time .overlay").remove(),b.update()},e.socketUpdate=function(b){var d=new Date(b.timestamp),e=d.getHours(),f=d.getMinutes(),g=(f-f%10)/10+6*e;"block"===b.type&&(g in c.ads?c.ads[g]++:c.ads[g]=1),g in c.domains?c.domains[g]++:c.domains[g]=1,a.updateTable()},e.onClickTimeline=function(a){var c=b.getElementAtEvent(a);if(c.length>0){var d=c[0]._index,e=b.data.labels[d],f=new Date(e),g=f.getHours()+":"+f.getMinutes(),h=f.getHours()+":"+padNumber(parseInt(f.getMinutes()+9),2);window.location.href="queries.php?from="+g+"&until="+h}return!1},a.subscribeSocket=function(){taillogWatcher.on("dns",e.socketUpdate)},a.unsubscribeSocket=function(){taillogWatcher.off("dns",e.socketUpdate)},a.start=function(){var c=document.getElementById("queryOverTimeChart").getContext("2d");b=new Chart(c,h),$("#queryOverTimeChart").click(e.onClickTimeline),a.pollData(),a.subscribeSocket()}}(queryTimelineUpdater);var topClientsChart={};!function(a){a.update=function(){$.getJSON("/api/data?summaryRaw&querySources",function(a){var b,c,d,e=$("#client-frequency").find("tbody:last");for(b in a.topSources)if({}.hasOwnProperty.call(a.topSources,b)){b=escapeHtml(b),d=b.indexOf("|")>-1?b.substr(0,b.indexOf("|")):b;var f='<a href="queries.php?client='+b+'">'+d+"</a>";c=a.topSources[b]/a.dns_queries_today*100,e.append("<tr> <td>"+f+"</td> <td>"+a.topSources[b]+'</td> <td> <div class="progress progress-sm" title="'+c.toFixed(1)+'%"> <div class="progress-bar progress-bar-blue" style="width: '+c+'%"></div> </div> </td> </tr> ')}$("#client-frequency .overlay").remove()})}}(topClientsChart);var forwardDestinationChart={};!function(a){var b;a.setup=function(){b=document.getElementById("forwardDestinationChart").getContext("2d"),a.chart=new Chart(b,{type:"doughnut",data:{labels:[],datasets:[{data:[]}]},options:{legend:{display:!1},animation:{duration:2e3},cutoutPercentage:0}})},a.update=function(){b||a.setup(),$.getJSON("/api/data?forwardDestinations",function(b){var c=[];$.each($.AdminLTE.options.colors,function(a,b){c.push(b)});var d=[],e=[];$.each(b.forwardDestinations,function(b,f){d.push(f),e.push(c.shift()),b.indexOf("|")>-1&&(b=b.substr(0,b.indexOf("|"))),a.chart.data.labels.push(b)});var f={data:d,backgroundColor:e};a.chart.data.datasets.push(f),$("#forward-destinations .overlay").remove(),a.chart.update(),a.chart.chart.config.options.cutoutPercentage=30,a.chart.update()})}}(forwardDestinationChart);const DomainTable=function(a){var b={};return function(a,b){var c=b.DataTable({processing:!0,paging:!1,ordering:!0,searching:!1,order:[[1,"desc"]],columnDefs:[{render:function(a,b,c){return'<div class="progress progress-sm" title="'+a.toFixed(1)+'%"> <div class="progress-bar progress-bar-yellow" style="width: '+a+'%"></div> </div>'},targets:2},{render:function(a,b,c){var d=escapeHtml(a);return'<a href="queries?domain='+d+'">'+d+"</a>"},targets:0}],columns:[{data:"domain",type:"string",orderable:!1},{data:"occurences",type:"num",orderable:!1},{data:"percent",type:"num",orderable:!1}]});a.setData=function(a,b){for(var d in a)if(Object.hasOwnProperty.call(a,d)){d=escapeHtml(d);const e={domain:d,occurences:a[d],percent:a[d]/b*100};c.row.add(e).draw()}c.draw()}}(b,a),b};var topLists={};!function(a){const b=new DomainTable($("#domain-frequency table.table"));a.update=function(){$.getJSON("/api/data?summary&topItems",function(a){var c,d,e,f=$("#ad-frequency").find("tbody:last");jQuery.isEmptyObject(a.topItems.topQueries)?$("#domain-frequency").parent().remove():b.setData(a.topItems.topQueries,a.summary.dnsQueriesToday);for(d in a.topItems.topAds)Object.hasOwnProperty.call(a.topItems.topAds,d)&&(d=escapeHtml(d),c='<a href="queries.php?domain='+d+'">'+d+"</a>",e=a.topAds[d]/a.ads_blocked_today*100,f.append("<tr> <td>"+c+"</td> <td>"+a.topAds[d]+'</td> <td> <div class="progress progress-sm" title="'+e.toFixed(1)+'%"> <div class="progress-bar progress-bar-yellow" style="width: '+e+'%"></div> </div> </td> </tr> '));$("#domain-frequency .overlay").remove(),$("#ad-frequency .overlay").remove()})}}(topLists);var queryTypeChart={};!function(a){var b;a.setup=function(){b=document.getElementById("queryTypeChart").getContext("2d"),a.chart=new Chart(b,{type:"doughnut",data:{labels:[],datasets:[{data:[]}]},options:{legend:{display:!1},animation:{duration:2e3},cutoutPercentage:0}})},a.update=function(){b||a.setup(),$.getJSON("/api/data?queryTypes",function(b){var c=[];$.each($.AdminLTE.options.colors,function(a,b){c.push(b)});var d=[],e=[];$.each(b.queryTypes,function(b,f){d.push(f),e.push(c.shift()),a.chart.data.labels.push(b.substr(6,b.length-7))});var f={data:d,backgroundColor:e};a.chart.data.datasets.push(f),$("#query-types .overlay").remove(),a.chart.update(),a.chart.chart.config.options.cutoutPercentage=30,a.chart.update()})}}(queryTypeChart),$(document).ready(function(){summaryUpdater.start(),queryTimelineUpdater.start(),document.getElementById("queryTypeChart")&&queryTypeChart.update(),document.getElementById("forwardDestinationChart")&&forwardDestinationChart.update(),document.getElementById("domain-frequency")&&document.getElementById("ad-frequency")&&topLists.update(),document.getElementById("client-frequency")&&topClientsChart.update()});