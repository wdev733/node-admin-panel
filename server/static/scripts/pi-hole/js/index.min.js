/*! pi1 - v1.0.0 -  2017 - 01 - 24  */
function objectToArray(p){var keys=Object.keys(p);keys.sort(function(a,b){return a-b});for(var arr=[],idx=[],i=0;i<keys.length;i++)arr.push(p[keys[i]]),idx.push(keys[i]);return[idx,arr]}function escapeHtml(text){var map={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return text.replace(/[&<>"']/g,function(m){return map[m]})}const padNumber=function(num){return("00"+num).substr(-2,2)};var summaryUpdater={};!function(sU){var summaryData={ads_blocked_today:-1,dns_queries_today:-1,domains_being_blocked:-1,ads_percentage_today:-1},callbacks={};callbacks.socketUpdate=function(data){data.type&&("block"===data.type&&summaryData.ads_blocked_today++,summaryData.dns_queries_today++,summaryData.ads_percentage_today=summaryData.ads_blocked_today/summaryData.dns_queries_today*100,sU.updateView())},sU.updateView=function(){["ads_blocked_today","dns_queries_today","domains_being_blocked","ads_percentage_today"].forEach(function(header,idx){var textData=3===idx?summaryData[header].toFixed(2)+"%":summaryData[header];$("h3#"+header).text(textData)}),$("#toprow-stats .overlay").each(function(idx,overlay){$(overlay).is(":visible")&&$(overlay).hide()})},sU.pollData=function(){$.getJSON("/api/data?summary",function(data){summaryData=data}).done(function(){sU.updateView()}).fail(function(){setTimeout(sU.pollData,300)})},sU.subscribeSocket=function(){taillogWatcher.on("dns",callbacks.socketUpdate)},sU.unsubscribeSocket=function(){taillogWatcher.off("dns",callbacks.socketUpdate)},sU.start=function(){sU.pollData(),sU.subscribeSocket()}}(summaryUpdater);var queryTimelineUpdater={};!function(qTU){var timeLineChart,tableData,failures=0,callbacks={};const timelineChartData={labels:[],datasets:[{label:"Total DNS Queries",fill:!0,backgroundColor:"rgba(220,220,220,0.5)",borderColor:"rgba(0, 166, 90,.8)",pointBorderColor:"rgba(0, 166, 90,.8)",pointRadius:1,pointHoverRadius:5,data:[],pointHitRadius:5,cubicInterpolationMode:"monotone"},{label:"Blocked DNS Queries",fill:!0,backgroundColor:"rgba(0,192,239,0.5)",borderColor:"rgba(0,192,239,1)",pointBorderColor:"rgba(0,192,239,1)",pointRadius:1,pointHoverRadius:5,data:[],pointHitRadius:5,cubicInterpolationMode:"monotone"}]},timelineChartOptions={tooltips:{enabled:!0,mode:"x-axis",callbacks:{title:function(tooltipItem,data){var label=tooltipItem[0].xLabel,time=label.match(/(\d?\d):?(\d?\d?)/),h=parseInt(time[1],10),m=parseInt(time[2],10)||0,from=padNumber(h)+":"+padNumber(m)+":00",to=padNumber(h)+":"+padNumber(m+9)+":59";return"Queries from "+from+" to "+to},label:function(tooltipItems,data){if(1===tooltipItems.datasetIndex){var percentage=0,total=parseInt(data.datasets[0].data[tooltipItems.index]),blocked=parseInt(data.datasets[1].data[tooltipItems.index]);return total>0&&(percentage=100*blocked/total),data.datasets[tooltipItems.datasetIndex].label+": "+tooltipItems.yLabel+" ("+percentage.toFixed(1)+"%)"}return data.datasets[tooltipItems.datasetIndex].label+": "+tooltipItems.yLabel}}},legend:{display:!1},scales:{xAxes:[{type:"time",time:{unit:"hour",displayFormats:{hour:"HH:mm"},tooltipFormat:"HH:mm"}}],yAxes:[{ticks:{beginAtZero:!0}}]},maintainAspectRatio:!1},timelineChartConfig={type:"line",data:timelineChartData,options:timelineChartOptions},sortNumberAsc=function(a,b){return a-b};qTU.pollData=function(){$.getJSON("/api/data?overTimeData",function(data){tableData=data,qTU.updateTable()}).done(function(){failures=0,setTimeout(qTU.pollData,6e5)}).fail(function(){failures++,failures<5&&setTimeout(qTU.pollData,6e4)})},qTU.updateTable=function(){timeLineChart.data.labels=[],timeLineChart.data.datasets[0].data=[],timeLineChart.data.datasets[1].data=[];for(var adsKeys=Object.keys(tableData.ads_over_time).map(Number).sort(sortNumberAsc),domainKeys=Object.keys(tableData.domains_over_time).map(Number).sort(sortNumberAsc),largest=Math.max(adsKeys[adsKeys.length-1],domainKeys[domainKeys.length-1]),smallest=Math.min(adsKeys[0],domainKeys[0]),timeInterval=smallest;timeInterval<=largest;timeInterval++){var h=timeInterval,d=(new Date).setHours(Math.floor(h/6),10*(h%6),0,0);timeLineChart.data.labels.push(d),timeLineChart.data.datasets[0].data.push(timeInterval in tableData.domains_over_time?tableData.domains_over_time[timeInterval]:0),timeLineChart.data.datasets[1].data.push(timeInterval in tableData.ads_over_time?tableData.ads_over_time[timeInterval]:0)}$("#queries-over-time .overlay").remove(),timeLineChart.update()},callbacks.socketUpdate=function(data){var timestamp=new Date(data.timestamp),hour=timestamp.getHours(),minute=timestamp.getMinutes(),timestampIdx=(minute-minute%10)/10+6*hour;"block"===data.type&&(timestampIdx in tableData.ads_over_time?tableData.ads_over_time[timestampIdx]++:tableData.ads_over_time[timestampIdx]=1),timestampIdx in tableData.domains_over_time?tableData.domains_over_time[timestampIdx]++:tableData.domains_over_time[timestampIdx]=1,qTU.updateTable()},callbacks.onClickTimeline=function(evt){var activePoints=timeLineChart.getElementAtEvent(evt);if(activePoints.length>0){var clickedElementindex=activePoints[0]._index,label=timeLineChart.data.labels[clickedElementindex],time=new Date(label),from=time.getHours()+":"+time.getMinutes(),until=time.getHours()+":"+padNumber(parseInt(time.getMinutes()+9),2);window.location.href="queries.php?from="+from+"&until="+until}return!1},qTU.subscribeSocket=function(){taillogWatcher.on("dns",callbacks.socketUpdate)},qTU.unsubscribeSocket=function(){taillogWatcher.off("dns",callbacks.socketUpdate)},qTU.start=function(){var ctx=document.getElementById("queryOverTimeChart").getContext("2d");timeLineChart=new Chart(ctx,timelineChartConfig),$("#queryOverTimeChart").click(callbacks.onClickTimeline),qTU.pollData(),qTU.subscribeSocket()}}(queryTimelineUpdater);var topClientsChart={};!function(tCC){tCC.update=function(){$.getJSON("/api/data?summaryRaw&getQuerySources",function(data){var domain,percentage,domainname,clienttable=$("#client-frequency").find("tbody:last");for(domain in data.topSources)if({}.hasOwnProperty.call(data.topSources,domain)){domain=escapeHtml(domain),domainname=domain.indexOf("|")>-1?domain.substr(0,domain.indexOf("|")):domain;var url='<a href="queries.php?client='+domain+'">'+domainname+"</a>";percentage=data.topSources[domain]/data.dns_queries_today*100,clienttable.append("<tr> <td>"+url+"</td> <td>"+data.topSources[domain]+'</td> <td> <div class="progress progress-sm" title="'+percentage.toFixed(1)+'%"> <div class="progress-bar progress-bar-blue" style="width: '+percentage+'%"></div> </div> </td> </tr> ')}$("#client-frequency .overlay").remove()})}}(topClientsChart);var forwardDestinationChart={};!function(fDU){var ctx;fDU.setup=function(){ctx=document.getElementById("forwardDestinationChart").getContext("2d"),fDU.chart=new Chart(ctx,{type:"doughnut",data:{labels:[],datasets:[{data:[]}]},options:{legend:{display:!1},animation:{duration:2e3},cutoutPercentage:0}})},fDU.update=function(){ctx||fDU.setup(),$.getJSON("/api/data?getForwardDestinations",function(data){var colors=[];$.each($.AdminLTE.options.colors,function(key,value){colors.push(value)});var v=[],c=[];$.each(data,function(key,value){v.push(value),c.push(colors.shift()),key.indexOf("|")>-1&&(key=key.substr(0,key.indexOf("|"))),fDU.chart.data.labels.push(key)});var dd={data:v,backgroundColor:c};fDU.chart.data.datasets.push(dd),$("#forward-destinations .overlay").remove(),fDU.chart.update(),fDU.chart.chart.config.options.cutoutPercentage=30,fDU.chart.update()})}}(forwardDestinationChart);const DomainTable=function(table){var dTable={};return function(tD,tableObj){var table=tableObj.DataTable({processing:!0,paging:!1,ordering:!0,searching:!1,order:[[1,"desc"]],columnDefs:[{render:function(data,type,row){return'<div class="progress progress-sm" title="'+data.toFixed(1)+'%"> <div class="progress-bar progress-bar-yellow" style="width: '+data+'%"></div> </div>'},targets:2},{render:function(data,type,row){var domain=escapeHtml(data);return'<a href="queries?domain='+domain+'">'+domain+"</a>"},targets:0}],columns:[{data:"domain",type:"string",orderable:!1},{data:"occurences",type:"num",orderable:!1},{data:"percent",type:"num",orderable:!1}]});tD.setData=function(data,dnsQueriesToday){for(var domain in data)if(Object.hasOwnProperty.call(data,domain)){domain=escapeHtml(domain);const rowData={domain:domain,occurences:data[domain],percent:data[domain]/dnsQueriesToday*100};table.row.add(rowData).draw()}table.draw()}}(dTable,table),dTable};var topLists={};!function(tL){const topQueryTable=new DomainTable($("#domain-frequency table.table"));tL.update=function(){$.getJSON("/api/data?summaryRaw&topItems",function(data){var url,domain,percentage,adtable=$("#ad-frequency").find("tbody:last");jQuery.isEmptyObject(data.topQueries)?$("#domain-frequency").parent().remove():topQueryTable.setData(data.topQueries,data.dns_queries_today);for(domain in data.topAds)Object.hasOwnProperty.call(data.topAds,domain)&&(domain=escapeHtml(domain),url='<a href="queries.php?domain='+domain+'">'+domain+"</a>",percentage=data.topAds[domain]/data.ads_blocked_today*100,adtable.append("<tr> <td>"+url+"</td> <td>"+data.topAds[domain]+'</td> <td> <div class="progress progress-sm" title="'+percentage.toFixed(1)+'%"> <div class="progress-bar progress-bar-yellow" style="width: '+percentage+'%"></div> </div> </td> </tr> '));$("#domain-frequency .overlay").remove(),$("#ad-frequency .overlay").remove()})}}(topLists);var queryTypeChart={};!function(qTC){var ctx;qTC.setup=function(){ctx=document.getElementById("queryTypeChart").getContext("2d"),qTC.chart=new Chart(ctx,{type:"doughnut",data:{labels:[],datasets:[{data:[]}]},options:{legend:{display:!1},animation:{duration:2e3},cutoutPercentage:0}})},qTC.update=function(){ctx||qTC.setup(),$.getJSON("/api/data?getQueryTypes",function(data){var colors=[];$.each($.AdminLTE.options.colors,function(key,value){colors.push(value)});var v=[],c=[];$.each(data,function(key,value){v.push(value),c.push(colors.shift()),qTC.chart.data.labels.push(key.substr(6,key.length-7))});var dd={data:v,backgroundColor:c};qTC.chart.data.datasets.push(dd),$("#query-types .overlay").remove(),qTC.chart.update(),qTC.chart.chart.config.options.cutoutPercentage=30,qTC.chart.update()})}}(queryTypeChart),$(document).ready(function(){summaryUpdater.start(),queryTimelineUpdater.start(),document.getElementById("queryTypeChart")&&queryTypeChart.update(),document.getElementById("forwardDestinationChart")&&forwardDestinationChart.update(),document.getElementById("domain-frequency")&&document.getElementById("ad-frequency")&&topLists.update(),document.getElementById("client-frequency")&&topClientsChart.update()});